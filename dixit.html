<!DOCTYPE html>
<html>
   <head>
      <title>Dixit</title>
      <style type="text/css">
        #welcome, #newGame, #games, #chat {
          display: block;
        }
        #alreadyPlayed, #alreadyVoted, #autoVote,
        #noVote, #nextRound, #scores, #wait, #hold,
        #controls, #notifications {
          display: none;
        }
        #write {
          width: 400px;
        }
      </style>
   </head>
   <script src = "/socket.io/socket.io.js"></script>
   <script>
     var socket = io();
     let player = '';
     socket.on('playersOnline', function(data) {
       let target = document.getElementById('players');
       let total = data.names.length;
       let online = [];
       let entry = ''
       while (online.length != total) {
         if (data.names[0] == player) {
           entry += 'you';
           data.names.shift()
         } else {
           entry += data.names.shift();
         }
         entry += ' (' + data.scores.shift() + ')'
         online.push(entry);
         entry = '';
       }
       online = online.join(', ');
       target.innerHTML = "Players: " + online + '.';
     });
     socket.on('removeFromPlay', function(data) {
       if (document.getElementById(data) != null) {
         document.getElementById(data).remove();
       }
     });
     socket.on('voteReleased', function() {
       let target = document.getElementById('notifications');
       let message = document.createTextNode('A player whose card you voted for has left the game. You can vote for another card.');
       target.appendChild(message);
       flashMessage('notifications');
     });
     socket.on('scoreUpdate', function(data) {
       let target = document.getElementById('scores');
       let output = data.scores.join(', ');
       target.innerHTML = output + '.';
       socket.emit('readyForNextRound');
       flashMessage('scores', 5000);
     });
     socket.on('storyteller', function(data) {
       let storyteller = document.getElementById('storyteller');
       if (data == player) {
         storyteller.innerHTML = "You are the storyteller this round.";
       } else {
         storyteller.innerHTML = data + " is the storyteller this round.";
       }
     });
     socket.on('cardsPlayed', function(data){
       let play = document.getElementById('play');
       for (let card of data) {
         showImage(card, play);
       }
     });
     socket.on('nextRound', function(data) {
       document.getElementById('play').innerHTML = '';
       if (data >= 0) {
         showImage(data);
       }
       flashMessage("nextRound");
     });
     socket.on('holdPlay', function(data) {
       showImage(data);
       flashMessage('hold');
     });
     socket.on('holdVote', function() {
       flashMessage('hold');
     });
     socket.on('wait', function(data) {
       showImage(data);
       flashMessage('wait');
     });
     socket.on('alreadyPlayed', function(data) {
       showImage(data);
       flashMessage("alreadyPlayed");
     });
     socket.on('alreadyVoted', function() {
       flashMessage("alreadyVoted");
     });
     socket.on('autoVote', function() {
       flashMessage("autoVote");
     });
     socket.on('noVote', function() {
       flashMessage("noVote")
     });
     socket.on('leftTheGame', function(data) {
       let target = document.getElementById('scores');
       target.innerHTML = data + " left the game.";
       flashMessage("notifications");
       console.log(data + " left the game.");
     });
     socket.on('newPlayer', function(data) {
       for (let card of data) {
        showImage(card);
       }
       let ctrl = document.getElementById('controls');
       let btntxt = document.createTextNode('Leave');
       let leave = document.createElement("button");
       leave.type = "button";
       leave.id = "leave";
       leave.onclick = function() {
         socket.emit('leaveGame');
         document.getElementById('newGame').style.display = "block";
         document.getElementById('games').style.display = "block";
         document.getElementById('controls').style.display = "none";
         document.getElementById('players').innerHTML = "";
         document.getElementById('storyteller').innerHTML = "";
         document.getElementById('hand').innerHTML = "";
         document.getElementById('leave').remove();
       }
       leave.appendChild(btntxt);
       ctrl.appendChild(leave);
       document.getElementById('controls').style.display = "block";
     });
     socket.on('gamesAvailable', function(games) {
       for (let game of games) {
         if (document.getElementById(game)) continue;
         let entry = document.createElement("div");
         entry.id = game;
         let title = document.createTextNode(game);
         let btntxt = document.createTextNode('Join');
         let join = document.createElement("button");
         join.type = "button";
         join.onclick = function() {
           socket.emit('joinGame', game);
           document.getElementById('newGame').style.display = "none";
           document.getElementById('games').style.display = "none";
         }
         join.appendChild(btntxt);
         entry.appendChild(title);
         entry.appendChild(join);
         document.getElementById('games').appendChild(entry);
       }
     });
     socket.on('closeGame', function(game) {
       document.getElementById(game).remove();
     });

     function flashMessage(elem, duration = 3000) {
       document.getElementById(elem).style.display = "block";
       setTimeout(function(){
         document.getElementById(elem).style.display = "none";
       }, duration);
     }
     function showImage(src, target = document.getElementById("hand")) {
       let image = document.createElement("img");
       image.src = "https://konntroll.github.io/memo/images/" + src + ".jpg";
       image.width = 200;
       image.height = 200;
       image.id = src;
       if (target == document.getElementById("hand")) {
         image.onclick = function () {
           socket.emit('playCard', src);
           this.parentElement.removeChild(this);
         }
       } else {
         image.onclick = function () {
           socket.emit('vote', image.id);
         }
       }
       target.appendChild(image);
     }
     function assignName() {
       if (event.keyCode === 13 || event.button === 0) {
         player = document.getElementById('name').value;
         socket.emit('assignName', player);
         document.getElementById('welcome').style.display = "none";
         document.getElementById('name').value = '';
       }
     }
     function newGame() {
       if (event.keyCode === 13 || event.button === 0) {
         document.getElementById('newGame').style.display = "none";
         document.getElementById('games').style.display = "none";
         socket.emit('startGame', document.getElementById('startGame').value);
         document.getElementById('startGame').value = '';
       }
     }
     function send() {
       if (event.keyCode === 13 || event.button === 0) {
         socket.emit('newMessage', document.getElementById('write').value);
         document.getElementById('write').value = '';
         document.getElementById('write').placeholder = 'Go on!';
       }
     }
     socket.on('transmit', function(message) {
       let speak = document.createTextNode(message);
       console.log(speak);
       document.getElementById('chat').appendChild(speak);
     })
   </script>
   <body>
     <div id="welcome">
       What's your name?
       <input id="name" type="text" placeholder="Don't be shy!" onkeyup="assignName()">
       <button id="namebtn" type="button" onclick="assignName()">That's me!</button>
     </div>
     <div id="newGame">
       Start a game. Choose a name:
       <input id="startGame" type="text" placeholder="Be creative!" onkeyup="newGame()">
       <button id="gamebtn" type="button" onclick="newGame()">Create!</button>
     </div>
     <div id="games"></div>
     <div id="game">
       <div id="info">
         <p id="controls"></p>
         <p id="players"></p>
         <p id="storyteller"></p>
         <p id="scores"></p>
         <p id="notifications"></p>
         <p id="wait"><b>NOTE:</b> Wait for the storyteller to play their card.</p>
         <p id="hold"><b>NOTE:</b> Wait for the round to finish.</p>
         <p id="alreadyPlayed"><b>NOTE:</b> You already played a card this round.</p>
         <p id="alreadyVoted"><b>NOTE:</b> You already voted for a card this round.</p>
         <p id="autoVote"><b>NOTE:</b> You can't vote for your own card.</p>
         <p id="noVote"><b>NOTE:</b> You can't vote this round because you are the storyteller.</p>
         <p id="nextRound"><b>NOTE:</b> Next round is starting!</p>
       </div>
       <div id='play'></div>
       <div id='hand'></div>
       <div id="chat">
         <input id="write" type="text" placeholder="Talk to others in this game..." onkeyup="send()">
         <button id="sendbtn" type="button" onclick="send()">Send!</button>
       </div>
     </div>
   </body>
</html>
